<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Pro Guitar Hero + Tuner</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        :root { --gold: #f5c542; --bg: #000; --green: #00ff88; }
        body { margin:0; background:var(--bg); color:#fff; font-family: sans-serif; overflow:hidden; touch-action: manipulation; }
        
        /* Navigation & Header */
        #backBtn { position:fixed; top:10px; left:10px; z-index:999; padding:10px 15px; background:rgba(255,255,255,0.2); border:none; color:white; border-radius:8px; cursor:pointer; }
        #score { position:absolute; top:10px; right:10px; color:var(--gold); font-size: 20px; font-weight: bold; }
        
        /* Screen Containers */
        .screen { display:none; position:absolute; inset:0; justify-content:center; align-items:center; flex-direction:column; text-align:center; padding: 20px; }
        #home { display:flex; }

        /* Tuner Specifics */
        .tuner-note { font-size:70px; font-weight: bold; margin: 10px 0; color: #fff; }
        .string-buttons { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; width: 100%; max-width: 350px; margin: 20px 0; }
        .string-buttons button { padding: 15px 5px; font-size: 18px; font-weight: bold; border-radius: 8px; border: 1px solid #444; background: #222; color: white; cursor: pointer; }
        .string-buttons button:active { background: var(--gold); color: black; }
        #tunerNeedle { width: 6px; height: 80px; background: red; border-radius: 3px; margin-top: 20px; transition: transform 0.1s ease-out; }

        /* Game Specifics */
        #hitLine { position:absolute; left:30%; top:0; width:4px; height:100%; background:var(--gold); box-shadow: 0 0 15px var(--gold); }
        .note { position:absolute; white-space:nowrap; font-size:20px; font-weight: bold; }

        /* General Buttons */
        .primary-btn { background: var(--gold); color: #000; font-weight: bold; padding: 15px 25px; border-radius: 10px; border: none; font-size: 18px; margin: 10px; cursor: pointer; }
    </style>
</head>
<body>

<button id="backBtn" onclick="goHome()" style="display:none;">â¬… Back</button>

<div id="home" class="screen">
    <h1 style="color:var(--gold)">ðŸŽ¸ Guitar Tool</h1>
    <button class="primary-btn" onclick="initAudio('tuner')">ðŸŽµ Open Tuner</button>
    <button class="primary-btn" onclick="initAudio('song', 'creep')">ðŸŽ¶ Play Creep</button>
    <p id="micStatus" style="font-size:12px; color:#666;">Waiting for tap...</p>
</div>

<div id="tuner" class="screen">
    <h2 style="margin:0; font-size:18px; color:var(--gold);">GUITAR TUNER</h2>
    <div class="tuner-note" id="tunerDisplay">E</div>
    
    <div class="string-buttons">
        <button onclick="setString('E')">E</button>
        <button onclick="setString('A')">A</button>
        <button onclick="setString('D')">D</button>
        <button onclick="setString('G')">G</button>
        <button onclick="setString('B')">B</button>
        <button onclick="setString('e')">e</button>
    </div>

    <div id="tunerNeedle"></div>
    <p style="font-size:12px; color:#888; margin-top:15px;">Pluck string near mic</p>
</div>

<div id="song" class="screen">
    <div id="score">Score: 0</div>
    <div id="hitLine"></div>
</div>

<script>
let audioCtx, analyser, mic, stream;
const stringFreqs = { E:82.41, A:110.00, D:146.83, G:196.00, B:246.94, e:329.63 };
const chordRoots = { G:196, B:247, C:262, Cm:262, F:349, Am:220 };
let currentString = 'E';

async function initAudio(targetScreen, songName) {
    try {
        if (!audioCtx) {
            stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            mic = audioCtx.createMediaStreamSource(stream);
            analyser = audioCtx.createAnalyser();
            analyser.fftSize = 2048;
            mic.connect(analyser);
        }
        if (audioCtx.state === 'suspended') await audioCtx.resume();
        
        document.getElementById('micStatus').innerText = "âœ… Mic Active";
        if (targetScreen === 'tuner') startTuner();
        if (targetScreen === 'song') startSong(songName);
    } catch (e) {
        alert("Please enable microphone access in Safari settings.");
    }
}

function getPitch() {
    if (!analyser) return null;
    const buf = new Float32Array(analyser.fftSize);
    analyser.getFloatTimeDomainData(buf);
    let sum = 0;
    for (let i=0; i<buf.length; i++) sum += buf[i]*buf[i];
    if (Math.sqrt(sum/buf.length) < 0.035) return null; // Sensitivity threshold
    let crossings = 0;
    for (let i=1; i<buf.length; i++) if (buf[i-1] < 0 && buf[i] >= 0) crossings++;
    return crossings * audioCtx.sampleRate / buf.length / 2;
}

function show(id) {
    document.querySelectorAll(".screen").forEach(s => s.style.display="none");
    document.getElementById(id).style.display="flex";
    document.getElementById("backBtn").style.display = id==="home" ? "none" : "block";
}

function goHome() { location.reload(); }

function setString(str) { 
    currentString = str; 
    document.getElementById('tunerDisplay').innerText = str; 
}

function startTuner() { show('tuner'); requestAnimationFrame(tunerLoop); }

function tunerLoop() {
    if (document.getElementById('tuner').style.display !== 'flex') return;
    const pitch = getPitch();
    const needle = document.getElementById('tunerNeedle');
    if (pitch) {
        const target = stringFreqs[currentString];
        const diff = pitch - target;
        let offset = Math.max(Math.min(diff / target * 200, 90), -90);
        needle.style.transform = `rotate(${offset/2}deg) translateX(${offset}px)`;
        needle.style.background = Math.abs(diff) < 2 ? '#00ff88' : 'red';
    }
    requestAnimationFrame(tunerLoop);
}

// Simple Game Logic
let songNotes = [], songStart = null, score = 0;
const songData = {
    creep: [{time:2, chord:"G", lyric:"When you were here before"}, {time:6, chord:"B", lyric:"Couldn't look you in the eyes"}],
    test: [{time:2, chord:"C", lyric:"Test Note 1"}]
};

function startSong(name) {
    show('song');
    songNotes = songData[name].map(n => {
        const el = document.createElement('div');
        el.className = 'note';
        el.innerHTML = `<div style="color:var(--gold)">${n.chord}</div><div style="font-size:12px">${n.lyric}</div>`;
        document.getElementById('song').appendChild(el);
        return { ...n, el, hit: false };
    });
    requestAnimationFrame(songLoop);
}

function songLoop(ts) {
    if (document.getElementById('song').style.display !== 'flex') return;
    if (!songStart) songStart = ts;
    const elapsed = (ts - songStart) / 1000;
    const pitch = getPitch();
    const hitLineX = window.innerWidth * 0.3;

    songNotes.forEach(n => {
        const x = hitLineX + (n.time - elapsed) * 150;
        n.el.style.left = x + 'px';
        n.el.style.top = '40%';
        if (!n.hit && Math.abs(x - hitLineX) < 20 && pitch) {
            if (Math.abs(pitch - chordRoots[n.chord]) < 15) {
                n.hit = true; score += 100;
                n.el.style.color = 'var(--green)';
                document.getElementById('score').innerText = `Score: ${score}`;
            }
        }
    });
    requestAnimationFrame(songLoop);
}
</script>
</body>
</html>
