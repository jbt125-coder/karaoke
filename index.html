<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Pro Guitar Hero + Tuner</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        :root { --gold: #f5c542; --bg: #000; --green: #00ff88; }
        body { margin:0; background:var(--bg); color:#fff; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; overflow:hidden; touch-action: manipulation; }
        button { font-size:18px; padding:12px 20px; margin:8px; border-radius: 8px; border:none; cursor:pointer; background: #333; color: white; }
        .primary-btn { background: var(--gold); color: #000; font-weight: bold; }
        .screen { display:none; position:absolute; inset:0; justify-content:center; align-items:center; flex-direction:column; text-align:center; padding: 20px; }
        #home { display:flex; }
        #backBtn { position:absolute; top:10px; left:10px; z-index:100; background: rgba(255,255,255,0.2); }
        #score { position:absolute; top:10px; right:10px; color:var(--gold); font-size: 20px; font-weight: bold; }
        #hitLine { position:absolute; left:30%; top:0; width:4px; height:100%; background:var(--gold); box-shadow: 0 0 15px var(--gold); }
        .note { position:absolute; white-space:nowrap; font-size:20px; font-weight: bold; transition: color 0.2s; }
        #tunerNeedle { position:absolute; bottom:20%; left:50%; width:6px; height:150px; background:red; transform:translateX(-50%); transition: transform 0.1s ease-out; border-radius: 3px; }
        .tuner-note { font-size:60px; font-weight: bold; margin-bottom: 20px; }
        .string-buttons { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        #micStatus { margin-top:15px; font-size:14px; color: #aaa; }
    </style>
</head>
<body>

<button id="backBtn" onclick="goHome()" style="display:none;">â¬… Back</button>

<div id="home" class="screen">
    <h1>ðŸŽ¸ Guitar Prototype</h1>
    <p>Works on iPhone, Android, & Laptop</p>
    <button class="primary-btn" onclick="initAudio('tuner')">ðŸŽµ Open Guitar Tuner</button>
    <button class="primary-btn" onclick="initAudio('song', 'creep')">ðŸŽ¶ Play "Creep"</button>
    <button onclick="initAudio('song', 'test')">ðŸŽ¼ Play Test Song</button>
    <div id="micStatus">Microphone: Waiting...</div>
</div>

<div id="tuner" class="screen">
    <div class="tuner-note" id="tunerDisplay">E</div>
    <div class="string-buttons">
        <button onclick="setString('E')">E</button><button onclick="setString('A')">A</button><button onclick="setString('D')">D</button>
        <button onclick="setString('G')">G</button><button onclick="setString('B')">B</button><button onclick="setString('e')">e</button>
    </div>
    <div id="tunerNeedle"></div>
</div>

<div id="song" class="screen">
    <div id="score">Score: 0</div>
    <div id="hitLine"></div>
</div>

<script>
/* ---------- AUDIO CORE ---------- */
let audioCtx, analyser, mic, stream;
const stringFreqs = { E:82.41, A:110.00, D:146.83, G:196.00, B:246.94, e:329.63 };
const chordRoots = { G:196, B:247, C:262, Cm:262, F:349, Am:220 };
let currentString = 'E';

async function initAudio(targetScreen, songName) {
    try {
        if (!audioCtx) {
            stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            mic = audioCtx.createMediaStreamSource(stream);
            analyser = audioCtx.createAnalyser();
            analyser.fftSize = 2048;
            mic.connect(analyser);
        }
        if (audioCtx.state === 'suspended') await audioCtx.resume();
        
        document.getElementById('micStatus').innerText = "âœ… Mic Active";
        
        if (targetScreen === 'tuner') startTuner();
        if (targetScreen === 'song') startSong(songName);
    } catch (e) {
        alert("Microphone error: Please use HTTPS and allow mic access.");
        console.error(e);
    }
}

function getPitch() {
    if (!analyser) return null;
    const buf = new Float32Array(analyser.fftSize);
    analyser.getFloatTimeDomainData(buf);
    
    // Volume check (RMS)
    let sum = 0;
    for (let i=0; i<buf.length; i++) sum += buf[i]*buf[i];
    if (Math.sqrt(sum/buf.length) < 0.04) return null; 

    let crossings = 0;
    for (let i=1; i<buf.length; i++) if (buf[i-1] < 0 && buf[i] >= 0) crossings++;
    return crossings * audioCtx.sampleRate / buf.length / 2;
}

/* ---------- NAVIGATION ---------- */
function show(id) {
    document.querySelectorAll(".screen").forEach(s => s.style.display="none");
    document.getElementById(id).style.display="flex";
    document.getElementById("backBtn").style.display = id==="home" ? "none" : "block";
}
function goHome() { location.reload(); } // Simplest way to reset audio state

/* ---------- TUNER LOGIC ---------- */
function setString(str) { currentString = str; document.getElementById('tunerDisplay').innerText = str; }
function startTuner() { show('tuner'); requestAnimationFrame(tunerLoop); }
function tunerLoop() {
    if (document.getElementById('tuner').style.display !== 'flex') return;
    const pitch = getPitch();
    const needle = document.getElementById('tunerNeedle');
    if (pitch) {
        const target = stringFreqs[currentString];
        const diff = pitch - target;
        let offset = Math.max(Math.min(diff / target * 250, 100), -100);
        needle.style.transform = `translateX(-50%) rotate(${offset/2}deg) translateX(${offset}px)`;
        needle.style.background = Math.abs(diff) < 2 ? '#00ff88' : 'red';
    }
    requestAnimationFrame(tunerLoop);
}

/* ---------- GAME LOGIC ---------- */
const songData = {
    creep: [
        {time:2, chord:"G", lyric:"When you were here before"},
        {time:6, chord:"B", lyric:"Couldn't look you in the eyes"},
        {time:10, chord:"C", lyric:"You're just like an angel"}
    ],
    test: [
        {time:2, chord:"C", lyric:"Test Note 1"}, {time:5, chord:"F", lyric:"Test Note 2"}
    ]
};
let songNotes = [], songStart = null, score = 0;

function startSong(name) {
    show('song');
    songNotes = songData[name].map(n => {
        const el = document.createElement('div');
        el.className = 'note';
        el.innerHTML = `<div style="color:var(--gold)">${n.chord}</div><div style="font-size:12px">${n.lyric}</div>`;
        document.getElementById('song').appendChild(el);
        return { ...n, el, hit: false };
    });
    requestAnimationFrame(songLoop);
}

function songLoop(ts) {
    if (document.getElementById('song').style.display !== 'flex') return;
    if (!songStart) songStart = ts;
    const elapsed = (ts - songStart) / 1000;
    const pitch = getPitch();
    const hitLineX = window.innerWidth * 0.3;

    songNotes.forEach(n => {
        const x = hitLineX + (n.time - elapsed) * 150;
        n.el.style.left = x + 'px';
        n.el.style.top = '40%';

        if (!n.hit && Math.abs(x - hitLineX) < 20 && pitch) {
            const target = chordRoots[n.chord];
            if (Math.abs(pitch - target) < 15) {
                n.hit = true; score += 100;
                n.el.style.color = 'var(--green)';
                document.getElementById('score').innerText = `Score: ${score}`;
            }
        }
    });
    requestAnimationFrame(songLoop);
}
</script>
</body>
</html>
